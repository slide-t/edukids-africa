const express = require("express");
const multer = require("multer");
const fs = require("fs");
const cors = require("cors");
const app = express();
const PORT = 5000;

app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Multer setup for photo uploads
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, "uploads/"),
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname)
});
const upload = multer({ storage });

// Path for saving registered students
const dataFile = "./students.json";

// Helper: Save to JSON
function saveStudent(student) {
  let students = [];
  if (fs.existsSync(dataFile)) {
    students = JSON.parse(fs.readFileSync(dataFile));
  }
  students.push(student);
  fs.writeFileSync(dataFile, JSON.stringify(students, null, 2));
}

// Registration endpoint
app.post("/register", upload.single("photo"), (req, res) => {
  const { fullname, dob, age, class: studentClass, emailType, email, countryOrigin, countryResidence } = req.body;

  const studentData = {
    fullname,
    dob,
    age,
    studentClass,
    emailType,
    email,
    countryOrigin,
    countryResidence,
    photo: req.file ? req.file.filename : null,
    dateRegistered: new Date()
  };

  // Save student
  saveStudent(studentData);

  res.json({ message: "✅ Student registered successfully!", student: studentData });
});

// Start server
app.listen(PORT, () => console.log(`✅ Server running at http://localhost:${PORT}`));
