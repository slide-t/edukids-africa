const express = require("express");
const multer = require("multer");
const fs = require("fs");
const cors = require("cors");

const app = express();
const PORT = 5000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ✅ Serve uploaded photos
app.use("/uploads", express.static("uploads"));

// Multer setup for photo uploads
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, "uploads/"),
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname)
});
const upload = multer({ storage });

// Path for saving registered students
const dataFile = "./students.json";

// Helper: Save to JSON
function saveStudent(student) {
  let students = [];
  if (fs.existsSync(dataFile)) {
    students = JSON.parse(fs.readFileSync(dataFile));
  }
  students.push(student);
  fs.writeFileSync(dataFile, JSON.stringify(students, null, 2));
}

// Registration endpoint
app.post("/register", upload.single("photo"), (req, res) => {
  const { fullname, dob, age, class: studentClass, emailType, email, countryOrigin, countryResidence } = req.body;

  const studentData = {
    fullname,
    dob,
    age,
    studentClass,
    email,
    emailType,
    countryOrigin,
    countryResidence,
    photo: req.file ? req.file.filename : null,
    dateRegistered: new Date()
  };

  saveStudent(studentData);
  res.json({ message: "✅ Student registered successfully", student: studentData });
});

// ✅ Students API with search & pagination
app.get("/students", (req, res) => {
  if (!fs.existsSync(dataFile)) return res.json([]);

  let students = JSON.parse(fs.readFileSync(dataFile));

  // --- Search filter ---
  const { search, page = 1, limit = 10 } = req.query;
  if (search) {
    const lowerSearch = search.toLowerCase();
    students = students.filter(s =>
      (s.fullname && s.fullname.toLowerCase().includes(lowerSearch)) ||
      (s.countryOrigin && s.countryOrigin.toLowerCase().includes(lowerSearch)) ||
      (s.countryResidence && s.countryResidence.toLowerCase().includes(lowerSearch)) ||
      (s.studentClass && s.studentClass.toLowerCase().includes(lowerSearch))
    );
  }

  // --- Pagination ---
  const startIndex = (page - 1) * limit;
  const paginatedStudents = students.slice(startIndex, startIndex + parseInt(limit));

  res.json({
    total: students.length,
    page: parseInt(page),
    limit: parseInt(limit),
    students: paginatedStudents
  });
});

const { Parser } = require("json2csv");

// Download students as CSV
app.get("/export/csv", (req, res) => {
  if (!fs.existsSync(dataFile)) {
    return res.status(404).send("No student data available");
  }

  const students = JSON.parse(fs.readFileSync(dataFile));

  const fields = [
    "fullname",
    "dob",
    "age",
    "studentClass",
    "email",
    "countryOrigin",
    "countryResidence",
    "photo",
    "dateRegistered"
  ];

  const json2csv = new Parser({ fields });
  const csv = json2csv.parse(students);

  res.header("Content-Type", "text/csv");
  res.attachment("students.csv");
  return res.send(csv);
});

app.listen(PORT, () => console.log(`✅ Server running at http://localhost:${PORT}`));



